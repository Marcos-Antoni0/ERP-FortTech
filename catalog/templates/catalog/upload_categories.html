<div class="container-fluid">
    <div class="alert alert-info">
        <h6 class="mb-2">Importação de Categorias via Excel</h6>
        <p class="mb-2">Envie um arquivo <strong>.xlsx</strong> seguindo o modelo disponibilizado. A planilha deve conter as seguintes colunas: <strong>{{ expected_headers|join:', ' }}</strong>.</p>
        <ul class="mb-2">
            <li><strong>Nome</strong>: nome da categoria (obrigatório).</li>
            <li><strong>Descrição</strong>: detalhes ou observações sobre a categoria.</li>
            <li><strong>Status</strong>: utilize <em>Ativo</em> ou <em>Inativo</em> (também são aceitos os valores 1 ou 0).</li>
        </ul>
        <p class="mb-0">As categorias com o mesmo nome serão atualizadas. As demais serão adicionadas à sua empresa.</p>
    </div>

    <form id="upload-category-form" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="category_file" class="form-label">Arquivo de categorias (.xlsx)</label>
            <input type="file" class="form-control" id="category_file" name="file" accept=".xlsx" required>
            <div class="form-text">Utilize o <a href="{% url 'download-category-template' %}">modelo de importação</a> como referência.</div>
        </div>
        <div class="d-flex justify-content-end gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'download-category-template' %}">
                <i class="mdi mdi-file-download"></i> Baixar modelo
            </a>
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="mdi mdi-upload"></i> Importar categorias
            </button>
        </div>
    </form>

    <div id="import-errors" class="mt-3 d-none">
        <div class="alert alert-warning mb-2 py-2 px-3">
            Algumas linhas não puderam ser importadas. Revise as pendências abaixo:
        </div>
        <ul class="list-group small"></ul>
    </div>
</div>

<script>
    $(function() {
        $('#upload-category-form').submit(function(e) {
            e.preventDefault();
            var form = $(this);
            $('.err-msg').remove();
            $('#import-errors').addClass('d-none').find('ul').empty();

            if (this.checkValidity() === false) {
                this.reportValidity();
                return false;
            }

            var el = $('<div>').addClass('err-msg alert').hide();

            start_loader();
            $.ajax({
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                url: "{% url 'upload-categories-page' %}",
                method: 'POST',
                data: new FormData(this),
                cache: false,
                contentType: false,
                processData: false,
                dataType: 'json',
                error: function(err) {
                    console.log(err);
                    el.removeClass('alert-success alert-warning').addClass('alert-danger');
                    el.text('Ocorreu um erro ao importar o arquivo.');
                    form.prepend(el);
                    el.show('slow');
                    end_loader();
                },
                success: function(resp) {
                    el.removeClass('alert-success alert-warning alert-danger');
                    if (typeof resp === 'object') {
                        if (resp.status === 'success') {
                            el.addClass('alert-success');
                            el.text(resp.msg || 'Categorias importadas com sucesso.');
                            form.prepend(el);
                            el.show('slow');
                            setTimeout(function() { location.reload(); }, 800);
                        } else if (resp.status === 'partial') {
                            el.addClass('alert-warning');
                            el.text(resp.msg || 'Importação concluída com pendências.');
                            form.prepend(el);
                            el.show('slow');
                            if (Array.isArray(resp.errors)) {
                                var list = $('#import-errors ul');
                                resp.errors.forEach(function(message) {
                                    list.append($('<li class="list-group-item list-group-item-warning">').text(message));
                                });
                                $('#import-errors').removeClass('d-none');
                            }
                        } else {
                            el.addClass('alert-danger');
                            el.text(resp.msg || 'Não foi possível processar o arquivo.');
                            form.prepend(el);
                            el.show('slow');
                        }
                    } else {
                        el.addClass('alert-danger');
                        el.text('Resposta inesperada do servidor.');
                        form.prepend(el);
                        el.show('slow');
                    }
                    end_loader();
                }
            });
        });
    });
</script>